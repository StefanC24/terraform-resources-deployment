name: Deploy Cloud Resources

on:
  workflow_dispatch:
    inputs:
      resource_type:
        description: 'Select the resource to deploy'
        required: true
        default: 'storage'
        type: choice
        options:
        - storage account
        - cosmos db
        - azure databricks
        - event grid domain
        - function app
        - data factory
      action:
        description: 'Select the action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: latest

    - name: Terraform Init
      env:
        TF_VAR_client_id: ${{ secrets.CLIENT_ID }}
        TF_VAR_client_secret: ${{ secrets.CLIENT_SECRET }}
        TF_VAR_tenant_id: ${{ secrets.TENANT_ID }}
        TF_VAR_subscription_id: ${{ secrets.SUBSCRIPTION_ID }}
        ARM_CLIENT_ID: ${{ secrets.CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        ARM_TENANT_ID: ${{ secrets.TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}
      run: terraform init
      working-directory: ${{ github.workspace }}

    - name: Deploy Storage Account
      if: github.event.inputs.resource_type == 'storage account'
      env:
        TF_VAR_client_id: ${{ secrets.CLIENT_ID }}
        TF_VAR_client_secret: ${{ secrets.CLIENT_SECRET }}
        TF_VAR_tenant_id: ${{ secrets.TENANT_ID }}
        TF_VAR_subscription_id: ${{ secrets.SUBSCRIPTION_ID }}
      run: |
        if [ "${{ github.event.inputs.action }}" == "plan" ]; then
          terraform plan -target=azurerm_storage_account.storage -target=azurerm_resource_group.resource_group
        elif [ "${{ github.event.inputs.action }}" == "apply" ]; then
          terraform apply -auto-approve -target=azurerm_storage_account.storage -target=azurerm_resource_group.resource_group
        elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
          terraform destroy -auto-approve -target=azurerm_storage_account.storage -target=azurerm_resource_group.resource_group
        fi
      working-directory: ${{ github.workspace }}

    - name: Deploy Cosmos DB
      if: github.event.inputs.resource_type == 'cosmos db'
      env:
        TF_VAR_client_id: ${{ secrets.CLIENT_ID }}
        TF_VAR_client_secret: ${{ secrets.CLIENT_SECRET }}
        TF_VAR_tenant_id: ${{ secrets.TENANT_ID }}
        TF_VAR_subscription_id: ${{ secrets.SUBSCRIPTION_ID }}
        ARM_CLIENT_ID: ${{ secrets.CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        ARM_TENANT_ID: ${{ secrets.TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}
      run: |
        terraform plan -target=azurerm_cosmosdb_account.db -target=azurerm_resource_group.resource_group -out=tfplan
        terraform apply tfplan
      working-directory: ${{ github.workspace }}

    - name: Deploy Azure Databricks
      if: github.event.inputs.resource_type == 'azure databricks'
      env:
        TF_VAR_client_id: ${{ secrets.CLIENT_ID }}
        TF_VAR_client_secret: ${{ secrets.CLIENT_SECRET }}
        TF_VAR_tenant_id: ${{ secrets.TENANT_ID }}
        TF_VAR_subscription_id: ${{ secrets.SUBSCRIPTION_ID }}
        ARM_CLIENT_ID: ${{ secrets.CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        ARM_TENANT_ID: ${{ secrets.TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}
      run: |
        terraform plan -target=azurerm_databricks_workspace.databricks -target=azurerm_resource_group.resource_group -out=tfplan
        terraform apply tfplan
      working-directory: ${{ github.workspace }}

    - name: Deploy Event Grid Domain
      if: github.event.inputs.resource_type == 'event grid domain'
      env:
        TF_VAR_client_id: ${{ secrets.CLIENT_ID }}
        TF_VAR_client_secret: ${{ secrets.CLIENT_SECRET }}
        TF_VAR_tenant_id: ${{ secrets.TENANT_ID }}
        TF_VAR_subscription_id: ${{ secrets.SUBSCRIPTION_ID }}
        ARM_CLIENT_ID: ${{ secrets.CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        ARM_TENANT_ID: ${{ secrets.TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}
      run: |
        terraform plan -target=azurerm_eventgrid_domain.example -target=azurerm_resource_group.resource_group -out=tfplan
        terraform apply tfplan
      working-directory: ${{ github.workspace }}

    - name: Deploy Function App
      if: github.event.inputs.resource_type == 'function app'
      env:
        TF_VAR_client_id: ${{ secrets.CLIENT_ID }}
        TF_VAR_client_secret: ${{ secrets.CLIENT_SECRET }}
        TF_VAR_tenant_id: ${{ secrets.TENANT_ID }}
        TF_VAR_subscription_id: ${{ secrets.SUBSCRIPTION_ID }}
        ARM_CLIENT_ID: ${{ secrets.CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        ARM_TENANT_ID: ${{ secrets.TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}
      run: |
        terraform plan -target=azurerm_function_app.function_app -target=azurerm_resource_group.resource_group -out=tfplan
        terraform apply tfplan
      working-directory: ${{ github.workspace }}

    - name: Deploy Data Factory
      if: github.event.inputs.resource_type == 'data factory'
      env:
        TF_VAR_client_id: ${{ secrets.CLIENT_ID }}
        TF_VAR_client_secret: ${{ secrets.CLIENT_SECRET }}
        TF_VAR_tenant_id: ${{ secrets.TENANT_ID }}
        TF_VAR_subscription_id: ${{ secrets.SUBSCRIPTION_ID }}
        ARM_CLIENT_ID: ${{ secrets.CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        ARM_TENANT_ID: ${{ secrets.TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}
      run: |
        terraform plan -target=azurerm_data_factory.data_factory -target=azurerm_resource_group.resource_group -out=tfplan
        terraform apply tfplan
      working-directory: ${{ github.workspace }}

    - name: Output Deployment Summary
      run: |
        echo "Successfully deployed resource: ${{ github.event.inputs.resource_type }}"
